name: Archive Past Events

on:
  schedule:
    # Run daily at 7:00 AM UTC (after update-events workflow)
    - cron: '0 7 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  archive-events:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd scripts
          npm install

      - name: Backup data.js
        run: cp js/data.js js/data.js.backup

      - name: Archive past events
        id: archive
        run: |
          cd scripts
          node archive-events.js

      - name: Validate data.js syntax
        id: validate
        run: |
          node -e "
            const fs = require('fs');
            const content = fs.readFileSync('js/data.js', 'utf-8');
            try {
              new Function(content + '; return EVENTS_DATA;');
              console.log('Syntax validation passed');
            } catch (e) {
              console.error('Syntax validation FAILED:', e.message);
              process.exit(1);
            }
          "

      - name: Restore backup if validation failed
        if: failure()
        run: |
          echo "Restoring backup due to validation failure"
          cp js/data.js.backup js/data.js

      - name: Check for changes
        id: git-check
        run: |
          git diff --quiet js/data.js || echo "changes=true" >> $GITHUB_OUTPUT

      - name: Generate unique branch name
        if: steps.git-check.outputs.changes == 'true'
        id: branch-name
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="auto-archive/events-${TIMESTAMP}"
          echo "branch=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "Generated branch name: ${BRANCH_NAME}"

      - name: Show archive summary
        if: steps.git-check.outputs.changes == 'true'
        run: |
          node -e "
            const fs = require('fs');
            const content = fs.readFileSync('js/data.js', 'utf-8');
            const func = new Function(content + '; return EVENTS_DATA;');
            const data = func();
            const archived = data.events.filter(e => e.isArchived);
            const active = data.events.filter(e => !e.isArchived);
            console.log('Archive summary:');
            console.log('  Total events:', data.events.length);
            console.log('  Active events:', active.length);
            console.log('  Archived events:', archived.length);
            console.log('  - Events page:', archived.filter(e => e.page === 'events').length);
            console.log('  - Hackathons page:', archived.filter(e => e.page === 'hackathons').length);
            console.log('  - CFP page:', archived.filter(e => e.page === 'cfp').length);
          "

      - name: Create Pull Request
        if: steps.git-check.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Auto-archive: Move past events to archive"
          branch: ${{ steps.branch-name.outputs.branch }}
          delete-branch: true
          title: "Auto-archive: Past events archived (${{ steps.branch-name.outputs.branch }})"
          body: |
            ## Automated Event Archive

            This PR was automatically generated by the event archiver workflow.

            ### What this does:
            - Moves past events to the Archive tab on each page
            - Updates active event counts in the header
            - Events whose end date (or deadline for CFPs) has passed are archived

            ### Archive criteria:
            - **Regular events**: End date has passed
            - **CFPs**: Submission deadline has passed
            - **Events without end date**: Start date has passed

            Please review before merging.
          labels: |
            automated
            archive

      - name: Cleanup backup
        if: always()
        run: rm -f js/data.js.backup
